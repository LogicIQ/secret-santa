version: '3'

tasks:
  go:build:
    desc: Build the manager binary
    cmds:
      - go build -o bin/manager cmd/main.go

  go:test:
    desc: Run unit tests with coverage
    cmds:
      - go test -v -coverprofile=coverage.out ./pkg/generators/...
      - go tool cover -func=coverage.out

  go:manifests:
    desc: Generate CRD manifests
    cmds:
      - export PATH=$PATH:$(go env GOPATH)/bin && controller-gen crd rbac:roleName=manager-role webhook paths="./..." output:crd:artifacts:config=config/crd/bases

  docker:build:
    desc: Build Docker image
    cmds:
      - docker build -t secret-santa:latest .

  e2e:run:
    desc: Run complete e2e test suite
    cmds:
      # Setup
      - go install sigs.k8s.io/kind@latest || echo "Kind already installed"
      - go install sigs.k8s.io/controller-tools/cmd/controller-gen@latest || echo "Controller-gen already installed"
      - kind create cluster --config=e2e/k8s/kind-config.yaml --name=secret-santa-e2e || echo "Cluster exists, reusing..."
      - kubectl config use-context kind-secret-santa-e2e
      
      # Generate CRDs
      - task: go:manifests
      
      # Deploy
      - kubectl delete deployment secret-santa-controller -n secret-santa-system --ignore-not-found=true
      - task: docker:build
      - kind load docker-image secret-santa:latest --name=secret-santa-e2e
      - kubectl create namespace secret-santa-system --dry-run=client -o yaml | kubectl apply -f - || echo "Namespace exists"
      - kubectl apply -f config/crd/bases/
      - kubectl apply -f config/rbac/
      - kubectl apply -f config/manager/
      - kubectl wait --for=condition=available --timeout=180s deployment/secret-santa-controller -n secret-santa-system
      
      # Test
      - cd e2e/k8s && go mod tidy && go test -v ./... -tags=e2e

  e2e:cleanup:
    desc: Cleanup e2e environment
    cmds:
      - kind delete cluster --name=secret-santa-e2e || echo "Cluster doesn't exist"